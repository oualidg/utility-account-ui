<div class="detail-container">

  <!-- Back button -->
  <button mat-button (click)="goBack()" class="back-button">
    <mat-icon>arrow_back</mat-icon>
    Back to Providers
  </button>

  <!-- Loading -->
  @if (loadingProvider) {
    <div class="spinner-container">
      <mat-spinner diameter="48" />
    </div>
  }

  <!-- Error -->
  @if (error) {
    <mat-card class="error-card">
      <mat-card-content>
        <mat-icon>error_outline</mat-icon>
        <p>{{ error }}</p>
      </mat-card-content>
    </mat-card>
  }

  @if (!loadingProvider && !error && provider) {

    <!-- Header -->
    <div class="page-header">
      <h1>{{ provider.name }}</h1>
      <div class="header-actions">
        @if (provider.active) {
          <button mat-stroked-button color="warn" (click)="deactivate()">
            <mat-icon>block</mat-icon>
            Deactivate
          </button>
        } @else {
          <button mat-stroked-button color="primary" (click)="reactivate()">
            <mat-icon>check_circle</mat-icon>
            Reactivate
          </button>
        }
        <button mat-stroked-button (click)="regenerateKey()">
          <mat-icon>key</mat-icon>
          Regenerate Key
        </button>
      </div>
    </div>

    <!-- Provider info -->
    <mat-card class="info-card" appearance="outlined">
      <mat-card-header>
        <mat-card-title>Provider Information</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">Code</span>
            <span class="info-value">{{ provider.code }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Status</span>
            <span class="info-value">
              @if (provider.active) {
                <span class="badge-active">Active</span>
              } @else {
                <span class="badge-inactive">Inactive</span>
              }
            </span>
          </div>
          <div class="info-item">
            <span class="info-label">API Key Prefix</span>
            <span class="info-value">{{ provider.apiKeyPrefix }}...</span>
          </div>
          <div class="info-item">
            <span class="info-label">Created</span>
            <span class="info-value">{{ provider.createdAt | date:'medium' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Last Modified</span>
            <span class="info-value">{{ provider.updatedAt | date:'medium' }}</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Filter -->
    <mat-card class="filter-card" appearance="outlined">
      <mat-card-content>
        <div class="filter-row">
          <select class="filter-select" [(ngModel)]="selectedMonth">
            @for (month of months; track month.value) {
              <option [ngValue]="month.value">{{ month.label }}</option>
            }
          </select>

          <select class="filter-select" [(ngModel)]="selectedYear">
            @for (year of years; track year) {
              <option [ngValue]="year">{{ year }}</option>
            }
          </select>

          <button mat-raised-button class="load-button" (click)="loadReconciliation()">
            <mat-icon>search</mat-icon>
            Load
          </button>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Reconciliation summary -->
    @if (loadingRecon) {
      <div class="spinner-container">
        <mat-spinner diameter="48" />
      </div>
    }

    @if (!loadingRecon && reconciliation) {

      <!-- Summary cards -->
      <div class="summary-cards">
        <mat-card class="summary-card" appearance="outlined">
          <mat-card-content>
            <div class="summary-icon-row">
              <mat-icon class="summary-icon">payments</mat-icon>
            </div>
            <div class="summary-label">Total Transactions</div>
            <div class="summary-value">{{ reconciliation.totalCount }}</div>
          </mat-card-content>
        </mat-card>

        <mat-card class="summary-card" appearance="outlined">
          <mat-card-content>
            <div class="summary-icon-row">
              <mat-icon class="summary-icon">account_balance</mat-icon>
            </div>
            <div class="summary-label">Total Amount</div>
            <div class="summary-value">
              {{ reconciliation.totalAmount | currency:'ZAR':'symbol-narrow' }}
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Payments table with download -->
      <mat-card appearance="outlined">
        <mat-card-header>
          <mat-card-title>Payments ({{ reconciliation.payments.length }})</mat-card-title>
          <div class="card-header-actions">
            <button mat-stroked-button (click)="downloadCsv()" [disabled]="reconciliation.payments.length === 0">
              <mat-icon>download</mat-icon>
              Download CSV
            </button>
          </div>
        </mat-card-header>
        <mat-card-content>
          @if (reconciliation.payments.length === 0) {
            <p class="no-data">No payments found for this period.</p>
          } @else {
            <table mat-table [dataSource]="reconciliation.payments" class="payments-table">

              <ng-container matColumnDef="receiptNumber">
                <th mat-header-cell *matHeaderCellDef>Receipt</th>
                <td mat-cell *matCellDef="let p">{{ p.receiptNumber }}</td>
              </ng-container>

              <ng-container matColumnDef="amount">
                <th mat-header-cell *matHeaderCellDef>Amount</th>
                <td mat-cell *matCellDef="let p">
                  {{ p.amount | currency:'ZAR':'symbol-narrow' }}
                </td>
              </ng-container>

              <ng-container matColumnDef="paymentDate">
                <th mat-header-cell *matHeaderCellDef>Date</th>
                <td mat-cell *matCellDef="let p">{{ p.paymentDate | date:'medium' }}</td>
              </ng-container>

              <ng-container matColumnDef="accountNumber">
                <th mat-header-cell *matHeaderCellDef>Account</th>
                <td mat-cell *matCellDef="let p">{{ p.accountNumber }}</td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="paymentColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: paymentColumns"></tr>

            </table>
          }
        </mat-card-content>
      </mat-card>

    }

  }

</div>